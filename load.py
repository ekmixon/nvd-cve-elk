#!/usr/bin/env python

import json
import glob
import gzip
import os
import socket
import sys

# connect to logstash at localhost:5000
try:
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect(("localhost", 5000))
except Exception as e:
    print ("[!] Can't connect to logstash: " + str(e))
    sys.exit(1)

cve_count = 0
total_cve_count = 0
fileglob = "data/nvd/nvdcve-1.0-*.json.gz"
#fileglob = "data/nvd/test.json.gz"
files = glob.glob(fileglob)

for filename in files:
    with gzip.open(filename, "rb") as f:
        file_content = json.load(f)
        cve_count = len(file_content["CVE_Items"])
        total_cve_count = total_cve_count + cve_count
        print(f"[*] Sending {cve_count} CVEs to logstash - {filename}")
        for cve in file_content["CVE_Items"]:
            cve_id = cve["cve"]["CVE_data_meta"]["ID"]
            cve["year"] = cve_id.split("-")[1]
            cve["filename"] = os.path.basename(filename)
            #print ("[*] Sending " + cve_id + " to logstash")
            sock.sendall(json.dumps(cve) + "\n")

sock.close()
print(f"[*] TOTAL: {str(total_cve_count)}")
